"use strict";(self.webpackChunkhousing_repairs_online=self.webpackChunkhousing_repairs_online||[]).push([[9363],{3905:function(e,t,n){n.d(t,{Zo:function(){return u},kt:function(){return h}});var r=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,i=function(e,t){if(null==e)return{};var n,r,i={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=r.createContext({}),p=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},u=function(e){var t=p(e.components);return r.createElement(l.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,i=e.mdxType,a=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),d=p(n),h=i,m=d["".concat(l,".").concat(h)]||d[h]||c[h]||a;return n?r.createElement(m,o(o({ref:t},u),{},{components:n})):r.createElement(m,o({ref:t},u))}));function h(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var a=n.length,o=new Array(a);o[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:i,o[1]=s;for(var p=2;p<a;p++)o[p]=n[p];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},5968:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return s},contentTitle:function(){return l},metadata:function(){return p},assets:function(){return u},toc:function(){return c},default:function(){return h}});var r=n(7462),i=n(3366),a=(n(7294),n(3905)),o=["components"],s={sidebar_position:7},l="Adoption",p={unversionedId:"adoption",id:"adoption",title:"Adoption",description:"Code Repositories",source:"@site/docs/adoption.md",sourceDirName:".",slug:"/adoption",permalink:"/housing-repairs-online/adoption",editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/adoption.md",tags:[],version:"current",sidebarPosition:7,frontMatter:{sidebar_position:7},sidebar:"tutorialSidebar",previous:{title:"Alerting & Montoring",permalink:"/housing-repairs-online/alerting-and-monitoring/intro"},next:{title:"Spikes",permalink:"/housing-repairs-online/category/spikes"}},u={},c=[{value:"Code Repositories",id:"code-repositories",level:2},{value:"Nugets",id:"nugets",level:2},{value:"Infrastructure",id:"infrastructure",level:2},{value:"APIs",id:"apis",level:3},{value:"Frontend",id:"frontend",level:3},{value:"Deploying to Azure",id:"deploying-to-azure",level:2},{value:"Create a service principal",id:"create-a-service-principal",level:3},{value:"Terraform state storage",id:"terraform-state-storage",level:3},{value:"Adding GitHub actions job and secrets",id:"adding-github-actions-job-and-secrets",level:3},{value:"Deploy housing-repairs-online-frontend",id:"deploy-housing-repairs-online-frontend",level:3},{value:"Integration",id:"integration",level:2},{value:"Components",id:"components",level:3},{value:"3rd Party Systems",id:"3rd-party-systems",level:3},{value:"Alerting &amp; Monitoring",id:"alerting--monitoring",level:3},{value:"Configuration",id:"configuration",level:2},{value:"Documentation",id:"documentation",level:3}],d={toc:c};function h(e){var t=e.components,n=(0,i.Z)(e,o);return(0,a.kt)("wrapper",(0,r.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"adoption"},"Adoption"),(0,a.kt)("h2",{id:"code-repositories"},"Code Repositories"),(0,a.kt)("p",null,"Clone/fork the following repositories:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://github.com/City-of-Lincoln-Council/housing-repairs-online"},"housing-repairs-online")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://github.com/City-of-Lincoln-Council/housing-repairs-online-frontend"},"housing-repairs-online-frontend")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://github.com/City-of-Lincoln-Council/housing-repairs-online-api"},"housing-repairs-online-api")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://github.com/City-of-Lincoln-Council/HousingRepairsSchedulingApi"},"HousingRepairsSchedulingApi")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://github.com/City-of-Lincoln-Council/HousingManagementSystemApi"},"HousingManagementSystemApi")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://github.com/City-of-Lincoln-Council/HACT.Dtos"},"HACT.Dtos")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://github.com/City-of-Lincoln-Council/HousingRepairsOnline.Authentication"},"HousingRepairsOnline.Authentication"))),(0,a.kt)("p",null,"The latter 2 produce Nuget packages, which if made public, could remove the need to clone their repositories."),(0,a.kt)("h2",{id:"nugets"},"Nugets"),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"https://github.com/City-of-Lincoln-Council/HACT.Dtos"},"HACT.Dtos")," and ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/City-of-Lincoln-Council/HousingRepairsOnline.Authentication"},"HousingRepairsOnline.Authentication")," produce Nuget packages which are consumed by other components."),(0,a.kt)("p",null,"Each repository contains setup instructions which can be followed to establish connectivity."),(0,a.kt)("h2",{id:"infrastructure"},"Infrastructure"),(0,a.kt)("p",null,"Azure is the supported Cloud platform."),(0,a.kt)("p",null,"Create the following resouces in Azure:"),(0,a.kt)("h3",{id:"apis"},"APIs"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Azure app service plan",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Consider which service plan would best suit the needs. Premium V2 (P1v2: 1) is recommended"),(0,a.kt)("li",{parentName:"ul"},"Use a region which is geographically close to the users/residents and the 3rd party data"))),(0,a.kt)("li",{parentName:"ul"},"Azure app service for each API",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Create a 'staging' deployment slot"),(0,a.kt)("li",{parentName:"ul"},"Each app service (and it's deployment slot) will have a publish profile which needs to be added to the repository secrets",(0,a.kt)("sup",{parentName:"li",id:"fnref-1"},(0,a.kt)("a",{parentName:"sup",href:"#fn-1",className:"footnote-ref"},"1"))))),(0,a.kt)("li",{parentName:"ul"},"Cosmos DB",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"2 databases - production and staging"),(0,a.kt)("li",{parentName:"ul"},"Each with ",(0,a.kt)("inlineCode",{parentName:"li"},"repair-requests")," collections"))),(0,a.kt)("li",{parentName:"ul"},"Blob storage account",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Create 2 containers - production and staging")))),(0,a.kt)("h3",{id:"frontend"},"Frontend"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Create Azure Static Web App",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"A deployment token will need to be added to the repository secrets",(0,a.kt)("sup",{parentName:"li",id:"fnref-1"},(0,a.kt)("a",{parentName:"sup",href:"#fn-1",className:"footnote-ref"},"1")))))),(0,a.kt)("h2",{id:"deploying-to-azure"},"Deploying to Azure"),(0,a.kt)("p",null,"An Azure service principal is an identity created that can be used for automated tools such as GitHub actions to access Azure resources. This access is restricted by the roles assigned to the service principal, giving you control over which resources can be accessed and at which level. In order to assign access to the service principal, you must have the necessary access to so."),(0,a.kt)("h3",{id:"create-a-service-principal"},"Create a service principal"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Ask your subscription administrator to add you to the User Access Administrator role. ",(0,a.kt)("a",{parentName:"li",href:"https://docs.microsoft.com/en-us/azure/active-directory/develop/howto-create-service-principal-portal#check-azure-subscription-permissions"},"See documentation"),". (",(0,a.kt)("em",{parentName:"li"},"If the subscription administrator is creating the service principal, ensure that you request the environment variables as specified in the Adding GitHub actions job and secrets step"),")"),(0,a.kt)("li",{parentName:"ol"},"Create the service principal. ",(0,a.kt)("a",{parentName:"li",href:"https://docs.microsoft.com/en-us/azure/active-directory/develop/howto-create-service-principal-portal#register-an-application-with-azure-ad-and-create-a-service-principal"},"See documentation"),"."),(0,a.kt)("li",{parentName:"ol"},"Assign a role to the service principal as per ",(0,a.kt)("a",{parentName:"li",href:"https://docs.microsoft.com/en-us/azure/active-directory/develop/howto-create-service-principal-portal#assign-a-role-to-the-application"},"this documentation"),". If you are not able to do this, contact your subscription administrator as you do not have the permission to do so"),(0,a.kt)("li",{parentName:"ol"},"Create a client secret for your service principal. ",(0,a.kt)("a",{parentName:"li",href:"https://docs.microsoft.com/en-us/azure/active-directory/develop/howto-create-service-principal-portal#option-2-create-a-new-application-secret"},"See documentation"),". Make sure to keep a note of the secret or copy it to your clipboard")),(0,a.kt)("h3",{id:"terraform-state-storage"},"Terraform state storage"),(0,a.kt)("p",null,"Terraform is an infrastructure as code tool which we will be using to provision the Azure resources to deploy our application. Terraform needs to be able to store its state so it is aware of what resources it has created/destroyed/updated etc. This state will be stored remotely in an Azure storage container. Complete the following steps in the Azure web portal to create the storage container:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Create a resource group for your infrastructure or use an existing one where your resources can be deployed. This resource group will be used for all other resources you provision so you should make it generic, e.g. ",(0,a.kt)("inlineCode",{parentName:"li"},"housing-repairs-online"),". Add the resource group name and location as ",(0,a.kt)("inlineCode",{parentName:"li"},"RESOURCE_GROUP_NAME")," and ",(0,a.kt)("inlineCode",{parentName:"li"},"RESOURCE_GROUP_LOCATION")," respectively to github actions secrets."),(0,a.kt)("li",{parentName:"ol"},"Create a storage account use the resource group you created above. Add the name of the storage account you created to github secrets as ",(0,a.kt)("inlineCode",{parentName:"li"},"STORAGE_ACCOUNT_NAME"),"."),(0,a.kt)("li",{parentName:"ol"},"In that storage account, create a container called ",(0,a.kt)("inlineCode",{parentName:"li"},"tfstate"),". This is where your state files will live. Create a github action secret called ",(0,a.kt)("inlineCode",{parentName:"li"},"CONTAINER_NAME")," with the value ",(0,a.kt)("inlineCode",{parentName:"li"},"tfstate")),(0,a.kt)("li",{parentName:"ol"},"Create github actions secret called ",(0,a.kt)("inlineCode",{parentName:"li"},"STATE_KEY_NAME")," with the value ",(0,a.kt)("inlineCode",{parentName:"li"},"{SERVICE_NAME}.tfstate"))),(0,a.kt)("h3",{id:"adding-github-actions-job-and-secrets"},"Adding GitHub actions job and secrets"),(0,a.kt)("p",null,"Once you have added a remote backend to your Terraform and created a service principal, GitHub actions should be configured to deploy resources to Azure using Terraform. We will be using the ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/hashicorp/setup-terraform"},"setup-terraform")," action to run Terraform in github actions"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Add the following secrets as your github repository secrets, these are only available to you if you have access to create a service principal so ensure to request these if the service principal is being created for you, (Note: navigate to your Service principal under Active Directory \u2192 App registrations \u2192 select your app registration and navigate to overview):")),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:null},"Secret name"),(0,a.kt)("th",{parentName:"tr",align:null},"Value"))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},(0,a.kt)("inlineCode",{parentName:"td"},"AZURE_AD_CLIENT_SECRET")),(0,a.kt)("td",{parentName:"tr",align:null},"This is the client secret value that was generated for the service principal in section 4 of Create a service")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},(0,a.kt)("inlineCode",{parentName:"td"},"AZURE_AD_CLIENT_ID")),(0,a.kt)("td",{parentName:"tr",align:null},"This is the Application (client) ID")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},(0,a.kt)("inlineCode",{parentName:"td"},"AZURE_AD_TENANT_ID")),(0,a.kt)("td",{parentName:"tr",align:null},"This is the Directory (tenant) ID")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},(0,a.kt)("inlineCode",{parentName:"td"},"AZURE_SUBSCRIPTION_ID")),(0,a.kt)("td",{parentName:"tr",align:null},"Navigate to subscriptions and select the Subscription ID for your subscription")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},(0,a.kt)("inlineCode",{parentName:"td"},"STATIC_SITE_NAME")),(0,a.kt)("td",{parentName:"tr",align:null},"The name of your static site")))),(0,a.kt)("ol",{start:2},(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"You will then reference these as environment variables in your github actions workflow. There will be an example provided further down which you can replicate. This allows the setup-terraform action to use the service principal credentials to provision your resources.")),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Add STATE_KEY_NAME as a repository secret. This is the storage account key for your Terraform backend. You can obtain this value if you navigate to Storage accounts, select the storage account for your Terraform backend, select Access Keys, click on show keys and copy the top key value. (Note: These are rotating keys and are subject to change, this tutorial does not investigate how to work around this)")),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("a",{parentName:"p",href:"https://github.com/Newarkandsherwood/housing-repairs-online-frontend/blob/main/.github/workflows/azure-static-web-apps-purple-desert-05060ea03.yml"},"This")," is a link for an example workflow"))),(0,a.kt)("h3",{id:"deploy-housing-repairs-online-frontend"},"Deploy housing-repairs-online-frontend"),(0,a.kt)("p",null,"Now you have added all the resources that you need in Azure in Terraform, you are ready for the CI to apply the Terraform and deploy. The first CI run will provision the Azure static web app resource (however the deployment will fail and this is expected). Log in to the Azure web portal, navigate to the static webb app you provisioned and copy the ",(0,a.kt)("inlineCode",{parentName:"p"},"Manage deployment token")," value. Add this to github actions secret with the name ",(0,a.kt)("inlineCode",{parentName:"p"},"AZURE_STATIC_WEB_APPS_API_TOKEN"),". As you have now added this secret, the deployment should pass successfully on the second run."),(0,a.kt)("p",null,(0,a.kt)("em",{parentName:"p"},"There will be some future work to prevent the manual entry of the AZURE STATIC WEB APPS API TOKEN secret")),(0,a.kt)("h2",{id:"integration"},"Integration"),(0,a.kt)("h3",{id:"components"},"Components"),(0,a.kt)("p",null,"Some of the Housing Repairs Online components will need to integrate to one another.\nThis is by means of setting environment variables which is detailed within the documentation for each component."),(0,a.kt)("h3",{id:"3rd-party-systems"},"3rd Party Systems"),(0,a.kt)("p",null,"Connectivity needs to be establish to each 3rd party system requiring integration."),(0,a.kt)("p",null,"Each component would require access to the system it is integrating with, i.e. Housing Management System API needs Housing Management System (i.e. Universal Housing) connectivity."),(0,a.kt)("p",null,"If data is stored on premise, a VPN or other datalink should be setup so that cloud deployed infrastructure has visibility of on premise infrastructure."),(0,a.kt)("h3",{id:"alerting--monitoring"},"Alerting & Monitoring"),(0,a.kt)("p",null,"See ",(0,a.kt)("a",{parentName:"p",href:"./alerting-and-monitoring/intro"},"Alerting & Monitoring")," for details."),(0,a.kt)("h2",{id:"configuration"},"Configuration"),(0,a.kt)("p",null,"Each component's configuration is outlined in their own specific documentation."),(0,a.kt)("p",null,"Please refer to this documentation to configure each component."),(0,a.kt)("h3",{id:"documentation"},"Documentation"),(0,a.kt)("p",null,"This documentation uses ",(0,a.kt)("a",{parentName:"p",href:"https://docusaurus.io/"},"Docusaurus")," and is generated via Github actions."),(0,a.kt)("p",null,"After the ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/City-of-Lincoln-Council/housing-repairs-online"},"housing-repairs-online")," repository has been cloned/forked, follow these steps to ensure GitHub regenerates documentation when changes are made:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Set the branch to use for GitHub pages to ",(0,a.kt)("inlineCode",{parentName:"li"},"gh-pages")," (",(0,a.kt)("a",{parentName:"li",href:"https://docs.github.com/en/pages/getting-started-with-github-pages/configuring-a-publishing-source-for-your-github-pages-site"},"see here"),")"),(0,a.kt)("li",{parentName:"ul"},"Configure the repository by adding a Deploy Key and ",(0,a.kt)("inlineCode",{parentName:"li"},"ACTIONS_DEPLOY_KEY")," Secret (",(0,a.kt)("a",{parentName:"li",href:"https://github.com/marketplace/actions/github-pages-action#%EF%B8%8F-create-ssh-deploy-key"},"see here"),")")),(0,a.kt)("div",{className:"footnotes"},(0,a.kt)("hr",{parentName:"div"}),(0,a.kt)("ol",{parentName:"div"},(0,a.kt)("li",{parentName:"ol",id:"fn-1"},"When creating resource in Azure, if using Github integration, some of these secrets will be automatically added to the repository.",(0,a.kt)("a",{parentName:"li",href:"#fnref-1",className:"footnote-backref"},"\u21a9")))))}h.isMDXComponent=!0}}]);