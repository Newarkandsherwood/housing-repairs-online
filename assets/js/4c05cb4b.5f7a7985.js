"use strict";(self.webpackChunkhousing_repairs_online=self.webpackChunkhousing_repairs_online||[]).push([[6933],{3905:function(e,t,n){n.d(t,{Zo:function(){return u},kt:function(){return m}});var i=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,i,r=function(e,t){if(null==e)return{};var n,i,r={},a=Object.keys(e);for(i=0;i<a.length;i++)n=a[i],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(i=0;i<a.length;i++)n=a[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=i.createContext({}),p=function(e){var t=i.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},u=function(e){var t=p(e.components);return i.createElement(l.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},d=i.forwardRef((function(e,t){var n=e.components,r=e.mdxType,a=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),d=p(n),m=r,h=d["".concat(l,".").concat(m)]||d[m]||c[m]||a;return n?i.createElement(h,o(o({ref:t},u),{},{components:n})):i.createElement(h,o({ref:t},u))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var a=n.length,o=new Array(a);o[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,o[1]=s;for(var p=2;p<a;p++)o[p]=n[p];return i.createElement.apply(null,o)}return i.createElement.apply(null,n)}d.displayName="MDXCreateElement"},1834:function(e,t,n){n.r(t),n.d(t,{assets:function(){return l},contentTitle:function(){return o},default:function(){return c},frontMatter:function(){return a},metadata:function(){return s},toc:function(){return p}});var i=n(3117),r=(n(7294),n(3905));const a={},o="Application Security",s={unversionedId:"application-security/intro",id:"application-security/intro",title:"Application Security",description:"Storing and Retrieving Application Secrets",source:"@site/docs/application-security/intro.md",sourceDirName:"application-security",slug:"/application-security/intro",permalink:"/housing-repairs-online/application-security/intro",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/application-security/intro.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Scheduled Repairs Based on Area",permalink:"/housing-repairs-online/spikes/scheduled-repairs"},next:{title:"Architecture Descision Records",permalink:"/housing-repairs-online/decisions/"}},l={},p=[{value:"Storing and Retrieving Application Secrets",id:"storing-and-retrieving-application-secrets",level:2},{value:"Environment: Azure",id:"environment-azure",level:3},{value:"Mitigations",id:"mitigations",level:4},{value:"GitHub Masking",id:"github-masking",level:3},{value:"Secrets Store Setup (Azure Key Vault) for App Service",id:"secrets-store-setup-azure-key-vault-for-app-service",level:3}],u={toc:p};function c(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,i.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"application-security"},"Application Security"),(0,r.kt)("h2",{id:"storing-and-retrieving-application-secrets"},"Storing and Retrieving Application Secrets"),(0,r.kt)("h3",{id:"environment-azure"},"Environment: Azure"),(0,r.kt)("p",null,"When using Azure and Github actions, care should be taken to not run github actions in debug mode as the ",(0,r.kt)("inlineCode",{parentName:"p"},"azure/webapps-deploy@v2")," function required to deploy the app to azure will print out all the values saved in the App service configuration settings as the result of an internal method called ",(0,r.kt)("inlineCode",{parentName:"p"},"getAppSettings"),"."),(0,r.kt)("p",null,"There is a risk if any of the App service configuration values are sensitive because they would be printed into the github actions log if the workflow is run in debug mode."),(0,r.kt)("h4",{id:"mitigations"},"Mitigations"),(0,r.kt)("p",null,"The only way of mitigating the leaking of sensitive values in the GitHub logs is to use GitHub's log masking functionality. This can be used in conjunction with Azure key Vault."),(0,r.kt)("h3",{id:"github-masking"},"GitHub Masking"),(0,r.kt)("p",null,"GitHub masking is a way of defining masks that are applied to all Github Logs, including the logs output by 3rd party components."),(0,r.kt)("p",null,"References:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://www.tutorialworks.com/github-actions-mask-url/"},"https://www.tutorialworks.com/github-actions-mask-url/")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://pakstech.com/blog/github-actions-workflow-commands/"},"https://pakstech.com/blog/github-actions-workflow-commands/")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://docs.github.com/en/actions/using-workflows/workflow-commands-for-github-actions#masking-a-value-in-log"},"https://docs.github.com/en/actions/using-workflows/workflow-commands-for-github-actions#masking-a-value-in-log"))),(0,r.kt)("p",null,"Add masks in the following way in the GitHub pipeline workflow config. They must be added as part of the job that you wish masking to be applied to. It does not work if you put the step in its own job since the changes only apply to the job that the step is included with. "),(0,r.kt)("p",null,"Example code block:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'steps:\n      - name: Add mask to obscure secrets in debug logs\n        run: |\n          echo "::add-mask::${{ secrets.COSMOS_CONTAINER_NAME_STAGING }}"\n')),(0,r.kt)("p",null,"An ",(0,r.kt)("inlineCode",{parentName:"p"},"add-mask")," command is needed for each secret that you wish to obscure in the logs."),(0,r.kt)("h3",{id:"secrets-store-setup-azure-key-vault-for-app-service"},"Secrets Store Setup (Azure Key Vault) for App Service"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Register the Microsoft.ManagedIdentity and Microsoft.KeyVault resource providers to your subscription\nThe Azure Subsctription must be registered to use the following namespaces:"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"'Microsoft.ManagedIdentity'")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"'Microsoft.KeyVault'"))),(0,r.kt)("p",{parentName:"li"},"If these are not registered, when trying to create the terraform resources for the key vault and managed identity that would have permissions to access it, the terraform code will fail:"),(0,r.kt)("p",{parentName:"li"},"For example,"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-text"},'keyvault.VaultsClient#CreateOrUpdate: Failure sending request: StatusCode=409 -- Original Error: Code="MissingSubscriptionRegistration" Message="The subscription is not registered to use namespace \'Microsoft.KeyVault\'.\n')),(0,r.kt)("p",{parentName:"li"},"The terraform attribute ",(0,r.kt)("inlineCode",{parentName:"p"},"skip_provider_registration = true")," ",(0,r.kt)("strong",{parentName:"p"},"does not skip")," the need to register ",(0,r.kt)("inlineCode",{parentName:"p"},"Microsoft.ManagedIdentity")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"Microsoft.KeyVault"),". These will still need to be registered regardless and will fail the build if they aren't."),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"NOTE: To manage resource provider registrations, the service principal that is used to provision the infrastructure must have the correct permissions to do so."))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Create the key vault, access policy and a user managed identity for each App service.\nThe key vault cannot be accessed by app service without using an identity that has the permissions to access the key vault. Set the desired permissions within the key access policy, add it to the user managed identity and add the identity to the relevant app service."),(0,r.kt)("p",{parentName:"li"},"Best practice is to have a key vault per application, per environment to reduce the incident area if there was breach. See ",(0,r.kt)("a",{parentName:"p",href:"https://docs.microsoft.com/en-gb/azure/key-vault/general/best-practices"},"here"),"."))))}c.isMDXComponent=!0}}]);